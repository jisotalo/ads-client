<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Home - Unofficial Node.js ADS library for connecting to Beckhoff TwinCAT automation systems </title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Client.html">Client</a><ul class='methods'><li data-type='method'><a href="Client.html#.defaultSettings">defaultSettings</a></li><li data-type='method'><a href="Client.html#connect">connect</a></li><li data-type='method'><a href="Client.html#convertFromRaw">convertFromRaw</a></li><li data-type='method'><a href="Client.html#convertToRaw">convertToRaw</a></li><li data-type='method'><a href="Client.html#createVariableHandle">createVariableHandle</a></li><li data-type='method'><a href="Client.html#deleteVariableHandle">deleteVariableHandle</a></li><li data-type='method'><a href="Client.html#disconnect">disconnect</a></li><li data-type='method'><a href="Client.html#getDataType">getDataType</a></li><li data-type='method'><a href="Client.html#getEmptyPlcType">getEmptyPlcType</a></li><li data-type='method'><a href="Client.html#getSymbolInfo">getSymbolInfo</a></li><li data-type='method'><a href="Client.html#invokeRpcMethod">invokeRpcMethod</a></li><li data-type='method'><a href="Client.html#readAndCacheDataTypes">readAndCacheDataTypes</a></li><li data-type='method'><a href="Client.html#readAndCacheSymbols">readAndCacheSymbols</a></li><li data-type='method'><a href="Client.html#readDeviceInfo">readDeviceInfo</a></li><li data-type='method'><a href="Client.html#readPlcRuntimeState">readPlcRuntimeState</a></li><li data-type='method'><a href="Client.html#readRaw">readRaw</a></li><li data-type='method'><a href="Client.html#readRawByHandle">readRawByHandle</a></li><li data-type='method'><a href="Client.html#readRawByName">readRawByName</a></li><li data-type='method'><a href="Client.html#readRawBySymbol">readRawBySymbol</a></li><li data-type='method'><a href="Client.html#readRawMulti">readRawMulti</a></li><li data-type='method'><a href="Client.html#readSymbol">readSymbol</a></li><li data-type='method'><a href="Client.html#readSymbolVersion">readSymbolVersion</a></li><li data-type='method'><a href="Client.html#readSystemManagerState">readSystemManagerState</a></li><li data-type='method'><a href="Client.html#readUploadInfo">readUploadInfo</a></li><li data-type='method'><a href="Client.html#readWriteRaw">readWriteRaw</a></li><li data-type='method'><a href="Client.html#reconnect">reconnect</a></li><li data-type='method'><a href="Client.html#restartPlc">restartPlc</a></li><li data-type='method'><a href="Client.html#restartSystemManager">restartSystemManager</a></li><li data-type='method'><a href="Client.html#setDebugging">setDebugging</a></li><li data-type='method'><a href="Client.html#setSystemManagerToConfig">setSystemManagerToConfig</a></li><li data-type='method'><a href="Client.html#setSystemManagerToRun">setSystemManagerToRun</a></li><li data-type='method'><a href="Client.html#startPlc">startPlc</a></li><li data-type='method'><a href="Client.html#stopPlc">stopPlc</a></li><li data-type='method'><a href="Client.html#subscribe">subscribe</a></li><li data-type='method'><a href="Client.html#subscribeRaw">subscribeRaw</a></li><li data-type='method'><a href="Client.html#unsubscribe">unsubscribe</a></li><li data-type='method'><a href="Client.html#unsubscribeAll">unsubscribeAll</a></li><li data-type='method'><a href="Client.html#writeControl">writeControl</a></li><li data-type='method'><a href="Client.html#writeRaw">writeRaw</a></li><li data-type='method'><a href="Client.html#writeRawByHandle">writeRawByHandle</a></li><li data-type='method'><a href="Client.html#writeRawBySymbol">writeRawBySymbol</a></li><li data-type='method'><a href="Client.html#writeRawMulti">writeRawMulti</a></li><li data-type='method'><a href="Client.html#writeSymbol">writeSymbol</a></li></ul></li><li><a href="ClientException.html">ClientException</a></li></ul><h3>Namespaces</h3><ul><li><a href="-_LibraryInternals.html">_LibraryInternals</a><ul class='methods'><li data-type='method'><a href="-_LibraryInternals.html#._amsNedIdStrToByteArray">_amsNedIdStrToByteArray</a></li><li data-type='method'><a href="-_LibraryInternals.html#._byteArrayToAmsNedIdStr">_byteArrayToAmsNedIdStr</a></li><li data-type='method'><a href="-_LibraryInternals.html#._checkReceivedData">_checkReceivedData</a></li><li data-type='method'><a href="-_LibraryInternals.html#._console">_console</a></li><li data-type='method'><a href="-_LibraryInternals.html#._createAmsHeader">_createAmsHeader</a></li><li data-type='method'><a href="-_LibraryInternals.html#._createAmsTcpHeader">_createAmsTcpHeader</a></li><li data-type='method'><a href="-_LibraryInternals.html#._createAmsTcpRequest">_createAmsTcpRequest</a></li><li data-type='method'><a href="-_LibraryInternals.html#._deepMergeObjects">_deepMergeObjects</a></li><li data-type='method'><a href="-_LibraryInternals.html#._getDataTypeInfo">_getDataTypeInfo</a></li><li data-type='method'><a href="-_LibraryInternals.html#._getDataTypeRecursive">_getDataTypeRecursive</a></li><li data-type='method'><a href="-_LibraryInternals.html#._onAdsCommandReceived">_onAdsCommandReceived</a></li><li data-type='method'><a href="-_LibraryInternals.html#._onAmsTcpPacketReceived">_onAmsTcpPacketReceived</a></li><li data-type='method'><a href="-_LibraryInternals.html#._onConnectionLost">_onConnectionLost</a></li><li data-type='method'><a href="-_LibraryInternals.html#._onPlcRuntimeStateChanged">_onPlcRuntimeStateChanged</a></li><li data-type='method'><a href="-_LibraryInternals.html#._onRouterStateChanged">_onRouterStateChanged</a></li><li data-type='method'><a href="-_LibraryInternals.html#._onSymbolVersionChanged">_onSymbolVersionChanged</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseAdsData">_parseAdsData</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseAdsNotification">_parseAdsNotification</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseAmsHeader">_parseAmsHeader</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseAmsTcpHeader">_parseAmsTcpHeader</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseAmsTcpPacket">_parseAmsTcpPacket</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseDataType">_parseDataType</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseJsObjectToBuffer">_parseJsObjectToBuffer</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseJsVariableToPlc">_parseJsVariableToPlc</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parsePlcDataToObject">_parsePlcDataToObject</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parsePlcVariableToJs">_parsePlcVariableToJs</a></li><li data-type='method'><a href="-_LibraryInternals.html#._parseSymbolInfo">_parseSymbolInfo</a></li><li data-type='method'><a href="-_LibraryInternals.html#._readDataTypeInfo">_readDataTypeInfo</a></li><li data-type='method'><a href="-_LibraryInternals.html#._readSymbolInfo">_readSymbolInfo</a></li><li data-type='method'><a href="-_LibraryInternals.html#._registerAdsPort">_registerAdsPort</a></li><li data-type='method'><a href="-_LibraryInternals.html#._reInitializeInternals">_reInitializeInternals</a></li><li data-type='method'><a href="-_LibraryInternals.html#._reInitializeSubscriptions">_reInitializeSubscriptions</a></li><li data-type='method'><a href="-_LibraryInternals.html#._sendAdsCommand">_sendAdsCommand</a></li><li data-type='method'><a href="-_LibraryInternals.html#._socketReceive">_socketReceive</a></li><li data-type='method'><a href="-_LibraryInternals.html#._socketWrite">_socketWrite</a></li><li data-type='method'><a href="-_LibraryInternals.html#._subcribeToPlcRuntimeStateChanges">_subcribeToPlcRuntimeStateChanges</a></li><li data-type='method'><a href="-_LibraryInternals.html#._subscribe">_subscribe</a></li><li data-type='method'><a href="-_LibraryInternals.html#._subscribeToSymbolVersionChanges">_subscribeToSymbolVersionChanges</a></li><li data-type='method'><a href="-_LibraryInternals.html#._systemManagerStatePoller">_systemManagerStatePoller</a></li><li data-type='method'><a href="-_LibraryInternals.html#._trimPlcString">_trimPlcString</a></li><li data-type='method'><a href="-_LibraryInternals.html#._unregisterAdsPort">_unregisterAdsPort</a></li><li data-type='method'><a href="-_LibraryInternals.html#._unsubscribeAllInternals">_unsubscribeAllInternals</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    

    



    


    <section class="package">
        <h3> </h3>		
    </section>









    



    <section class="readme usertext">
        <article><h1 id="ads-client">ads-client</h1>
<p><a href="https://www.npmjs.org/package/ads-client"><img src="https://img.shields.io/npm/v/ads-client" alt="npm version"></a>
<a href="https://github.com/jisotalo/ads-client/milestone/1"><img src="https://img.shields.io/github/milestones/progress-percent/jisotalo/ads-client/1" alt="GitHub milestone"></a>
<a href="https://github.com/jisotalo/ads-client"><img src="https://img.shields.io/badge/View%20on-GitHub-brightgreen" alt="GitHub"></a>
<a href="https://choosealicense.com/licenses/mit/"><img src="https://img.shields.io/github/license/jisotalo/ads-client" alt="License"></a></p>
<p>Unofficial node.js ADS library for connecting to Beckhoff TwinCAT automation systems using ADS protocol.</p>
<p>Coded from scratch using <a href="https://infosys.beckhoff.com/content/1033/tc3_ads_intro/116157835.html?id=124964102706356243">TwinCAT ADS specification</a> and <a href="https://www.nuget.org/packages/Beckhoff.TwinCAT.Ads/5.0.0-preview6">Beckhoff.TwinCAT.Ads nuget package</a>. Inspiration from similar projects like <a href="https://www.npmjs.com/package/node-ads">node-ads</a>, <a href="https://www.npmjs.com/package/beckhoff-js">beckhoff-js</a> and <a href="https://www.npmjs.com/package/iecstruct">iecstruct</a>.</p>
<h1 id="table-of-contents">Table of contents</h1>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#installation">Features</a></li>
<li><a href="#supported-and-tested-platforms">Supported and tested platforms</a></li>
<li><a href="#connection-setups-and-possibilities">Connection setups and possibilities</a></li>
<li><a href="#enabling-localhost-support">Enabling localhost support</a></li>
<li><a href="#important-writing-struct-variables">IMPORTANT: Writing STRUCT variables</a></li>
<li><a href="#important-things-to-know-when-using-with-twincat-2">IMPORTANT: Things to know when using with TwinCAT 2</a></li>
<li><a href="#getting-started">Getting started</a>
<ul>
<li><a href="data-types-used-in-getting-started">Data types used in getting started</a></li>
<li><a href="#creating-a-new-client-instance">Creating a new Client instance</a></li>
<li><a href="#connecting-and-disconnecting">Connecting and disconnecting</a></li>
<li><a href="#reading-any-type-plc-variable">Reading any type PLC variable</a>
<ul>
<li><a href="#example-reading-int-type-variable">Example: Reading INT type variable</a></li>
<li><a href="#example-reading-string-type-variable">Example: Reading STRING type variable</a></li>
<li><a href="#example-reading-enum-type-variable">Example: Reading ENUM type variable</a></li>
<li><a href="#example-reading-struct-type-variable">Example: Reading STRUCT type variable</a></li>
<li><a href="#example-reading-array-of-int-type-variable">Example: Reading ARRAY OF INT type variable</a></li>
<li><a href="#example-reading-array-of-struct-type-variable">Example: Reading ARRAY OF STRUCT type variable</a></li>
<li><a href="#example-reading-function-block-type-variable">Example: Reading FUNCTION BLOCK type variable</a></li>
</ul>
</li>
<li><a href="#writing-any-type-plc-variable">Writing any type PLC variable</a>
<ul>
<li><a href="#example-writing-int-type-variable">Example: Writing INT type variable</a></li>
<li><a href="#example-writing-string-type-variable">Example: Writing STRING type variable</a></li>
<li><a href="#example-writing-enum-type-variable">Example: Writing ENUM type variable</a></li>
<li><a href="#example-writing-struct-type-variable">Example: Writing STRUCT type variable</a></li>
<li><a href="#example-writing-struct-type-variable-with-autofill-parameter">Example: Writing STRUCT type variable (with autoFill parameter)</a></li>
<li><a href="#example-writing-array-of-int-type-variable">Example: Writing ARRAY OF INT type variable</a></li>
<li><a href="#example-writing-array-of-struct-type-variable">Example: Writing ARRAY of STRUCT type variable</a></li>
<li><a href="#example-writing-function-block-type-variable">Example: Writing FUNCTION BLOCK type variable</a></li>
</ul>
</li>
<li><a href="#subscribing-to-plc-variables-device-notifications">Subscribing to PLC variables (device notifications)</a>
<ul>
<li><a href="#subcribe-to-variable-value-on-change">Subcribe to variable value (on-change)</a></li>
<li><a href="#subcribe-to-variable-value-cyclic">Subcribe to variable value (cyclic)</a></li>
</ul>
</li>
<li><a href="#reading-and-writing-raw-data">Reading and writing raw data</a>
<ul>
<li><a href="#getting-symbol-index-group-offset-and-size">Getting symbol index group, offset and size</a></li>
<li><a href="#reading-a-single-raw-value">Reading a single raw value</a></li>
<li><a href="#writing-a-single-raw-value">Writing a single raw value</a></li>
<li><a href="#reading-multiple-raw-values">Reading multiple raw values</a></li>
<li><a href="#writing-multiple-raw-values">Writing multiple raw values</a></li>
<li><a href="#creating-a-variable-handle-and-reading-a-raw-value">Creating a variable handle and reading a raw value</a></li>
<li><a href="#creating-a-variable-handle-and-writing-a-raw-value">Creating a variable handle and writing a raw value</a></li>
<li><a href="#converting-a-raw-value-to-javascript-object">Converting a raw value to Javascript object</a></li>
<li><a href="#converting-a-javascript-object-to-raw-value">Converting a Javascript object to raw value</a></li>
</ul>
</li>
<li><a href="#calling-a-function-block-method-with-parameters-using-rpc-remote-procedure-call">Calling a function block method with parameters using RPC (remote procedure call)</a></li>
<li><a href="#starting-and-stopping-the-plc">Starting and stopping the PLC</a></li>
<li><a href="#starting-and-stopping-the-twincat-system">Starting and stopping the TwinCAT system</a></li>
</ul>
</li>
<li><a href="#debugging">Debugging</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#documentation">Documentation</a></li>
<li><a href="#license">License</a></li>
</ul>
<h1 id="installation">Installation</h1>
<p>Install the <a href="https://www.npmjs.com/package/ads-client">npm package</a> using npm command:</p>
<pre class="prettyprint source lang-bash"><code>npm i ads-client
</code></pre>
<p>Include the module in your code</p>
<pre class="prettyprint source lang-js"><code>const ads = require('ads-client')
</code></pre>
<h1 id="features">Features</h1>
<ul>
<li>TwinCAT 2 and TwinCAT 3 support</li>
<li>Promise and async/await support</li>
<li>Supports connecting to the local TwinCAT 3 runtime (see <a href="#localhost-support">enabling localhost support</a>)</li>
<li>Supports multiple connections from the same host</li>
<li>Reading and writing all any PLC variable</li>
<li>Subscribing to PLC variables (ADS notifications)</li>
<li>Automatic conversion between PLC&lt;-&gt;Javascript objects</li>
<li>PLC symbol and data type handling and caching</li>
<li>Reading PLC runtime and system manager states</li>
<li>Automatic 32/64 bit variable support (PVOID, XINT, etc.)</li>
<li>Automatic cache and subscription refreshing when PLC program changes or system starts</li>
<li>Automatic byte alignment support (all pack-modes automatically supported)
<ul>
<li><strong>From version 1.6.0 upwards</strong></li>
<li>Older versions: <code>{attribute 'pack_mode' := '1'}</code> is required above STRUCT definition</li>
</ul>
</li>
<li>Possibility to call function block methods (RPC - remote procedure call)
<ul>
<li><strong>From version 1.8.0 upwards</strong></li>
</ul>
</li>
</ul>
<h1 id="supported-and-tested-platforms">Supported and tested platforms</h1>
<p>The ads-client package is tested so far with the following setups:</p>
<ul>
<li>TwinCAT 2.11 running on VirtualBox Windows XP 32bit <strong>(from version 1.9.0 upwards)</strong>
<ul>
<li>TwinCAT 2 support not tested with hardware PLC yet but should work</li>
</ul>
</li>
<li>TwinCAT 3 4020 running on 64bit Windows 10 <strong>(TC3 builds &lt;= 4020 are working from version 1.9.0 upwards)</strong></li>
<li>TwinCAT 3 4022.27 running on 64bit Windows 10</li>
<li>TwinCAT 3 4024.4 running on 64bit Windows 10</li>
<li>TwinCAT 3 4022.27 running on 32bit and 64bit Windows 7 Embedded on Beckhoff PLC</li>
<li>Node.js v10.16.3 and newer
<ul>
<li>NOTE: 64 bit integer values are supported only with Node.js v.12+</li>
</ul>
</li>
</ul>
<h1 id="connection-setups-and-possibilities">Connection setups and possibilities</h1>
<p>The ads-client can be used in different system configurations. The following figure has different possible setups:</p>
<p><a href="https://user-images.githubusercontent.com/13457157/82724547-8dde0800-9cdf-11ea-8dd1-0a1f06f8559f.PNG"><img src="https://user-images.githubusercontent.com/13457157/82724547-8dde0800-9cdf-11ea-8dd1-0a1f06f8559f.PNG" alt="ads-client-setups"></a></p>
<h2 id="setup-1---connect-from-windows-pc-to-the-plc">Setup 1 - Connect from Windows PC to the PLC</h2>
<p>Suggested use cases:</p>
<ul>
<li>When using Windows operating system and TwinCAT runtime can be installed</li>
<li>When opening a TCP port from PLC is a no-go</li>
</ul>
<p>Requirements:</p>
<ul>
<li>Client has TwinCAT runtime or XAE installed</li>
<li>ADS route is created between the client and the PLC</li>
</ul>
<p>Example connection to PLC with AmsNetId of <code>192.168.1.120.1.1</code>.</p>
<pre class="prettyprint source lang-js"><code>const client = new ads.Client({
  targetAmsNetId: '192.168.1.120.1.1',
  targetAdsPort: 851,
})
</code></pre>
<h2 id="setup-2---connecting-from-unix%2Fwindows%2Fetc.-system-to-the-plc">Setup 2 - Connecting from Unix/Windows/etc. system to the PLC</h2>
<p>Suggested use cases:</p>
<ul>
<li>On Windows when TwinCAT installation is not possible, but .NET Core is available</li>
<li>Unix based system and .NET Core available</li>
</ul>
<p>Requirements:</p>
<ul>
<li>Client has <a href="https://www.nuget.org/packages/Beckhoff.TwinCAT.Ads.AdsRouterConsole/5.0.0-preview4">AdsRouterConsole</a> running</li>
<li>ADS route is created between the client and the PLC (as in the nuget package instructions)</li>
</ul>
<p>Example connection when PLC has AmsNetId of <code>192.168.1.120.1.1</code>.</p>
<pre class="prettyprint source lang-js"><code>const client = new ads.Client({
  targetAmsNetId: '192.168.1.120.1.1',
  targetAdsPort: 851,
})
</code></pre>
<h2 id="setup-3---connecting-from-any-node.js-supported-system-to-the-plc">Setup 3 - Connecting from any Node.js supported system to the PLC</h2>
<p>Suggested use cases:</p>
<ul>
<li>When opening TCP port from PLC is possible</li>
<li>When fast connection is required (1 router less -&gt; faster response)</li>
</ul>
<p>Requirements:</p>
<ul>
<li>PLC has TCP port 48898 open (default router port)
<ul>
<li>NOTE: Windows Firewall might block, make sure Ethernet connection is handled as &quot;private&quot;</li>
</ul>
</li>
<li>Local AmsNetId and ADS port are given manually
<ul>
<li>Given <code>localAmsNetId</code> is not already in use</li>
<li>Given <code>localAdsPort</code> is not already in use</li>
</ul>
</li>
<li>PLC has ADS route manually created to client IP address and client <code>localAmsNetId</code>
<ul>
<li>See example after code sample</li>
</ul>
</li>
</ul>
<p>Example connection when PLC has AmsNetId of <code>192.168.1.120.1.1</code> and IP of <code>192.168.1.120</code>.</p>
<pre class="prettyprint source lang-js"><code>const client = new ads.Client({
  localAmsNetId: '192.168.1.10.1.1',  //Can be anything but needs to be in PLC StaticRoutes.xml file
  localAdsPort: 32750,                //Can be anything that is not used
  targetAmsNetId: '192.168.1.120.1.1',
  targetAdsPort: 851,
  routerAddress: '192.168.1.120',     //PLC ip address
  routerTcpPort: 48898                //PLC needs to have this port opened. Test disabling all firewalls if problems
})
</code></pre>
<p>Adding a route to the PLC can be done editing <code>TwinCAT\3.1\Target\StaticRoutes.xml</code> file from PLC. Add the following inside <code>&lt;RemoteConnections&gt;</code> tag. In this example, client should use meanual AmsNetId <code>192.168.1.10.1.1</code> and client has IP address <code>192.168.1.10</code>.</p>
<pre class="prettyprint source lang-xml"><code>&lt;Route>
  &lt;Name>UI&lt;/Name>
  &lt;Address>192.168.1.10&lt;/Address>
  &lt;NetId>192.168.1.10.1.1&lt;/NetId>
  &lt;Type>TCP_IP&lt;/Type>
  &lt;Flags>64&lt;/Flags>
&lt;/Route>
</code></pre>
<h2 id="setup-4---connect-to-the-localhost-(plc-and-client-on-the-same-machine)">Setup 4 - Connect to the localhost (PLC and client on the same machine)</h2>
<p>Suggested use cases:</p>
<ul>
<li>When testing PLC systems on the local computer</li>
<li>When using panel PC/PLC combination</li>
<li>When PLC has monitor and it's used as user interface</li>
</ul>
<p>Requirements:</p>
<ul>
<li>AMS router TCP loopback enabled (see <a href="#enabling-localhost-support">Enabling localhost support</a>)</li>
</ul>
<p>Example connection to local PLC runtime</p>
<pre class="prettyprint source lang-js"><code>const client = new ads.Client({
  targetAmsNetId: '127.0.0.1.1.1', //or 'localhost'
  targetAdsPort: 851,
})

</code></pre>
<h1 id="enabling-localhost-support-on-twincat-3">Enabling localhost support on TwinCAT 3</h1>
<p><em>NOTE: Only required for TwinCAT 3 versions older than 4024.5. Newer versions should have this already enabled.</em></p>
<p><em><strong>Note:</strong> Probably not working for TwinCAT 2</em></p>
<p>If you want to connect to the local TwinCAT runtime (Node.js and the TwinCAT on the same computer - <strong>as example setup 4</strong>), the ADS router TCP loopback feature has to be enabled. Tested with TwinCAT 4022.27 and 4024.4.</p>
<p>The following method is from <a href="https://www.nuget.org/packages/Beckhoff.TwinCAT.Ads/5.0.0-preview6">Beckhoff.TwinCAT.Ads nuget package</a> installation guide.</p>
<ol>
<li>
<p>Stop TwinCAT System Service</p>
</li>
<li>
<p>Open registery editor (<code>regedit</code>)</p>
</li>
<li>
<p>Depending on the operating system, navigate to</p>
</li>
</ol>
<pre class="prettyprint source"><code>32 bit operating system:
HKEY_LOCAL_MACHINE\SOFTWARE\Beckhoff\TwinCAT3\System\

64 bit it operating system:
HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Beckhoff\TwinCAT3\System\
</code></pre>
<ol start="4">
<li>Create new DWORD registery named <code>EnableAmsTcpLoopback</code> and set value to 1 (example figure below from 64 bit system)</li>
</ol>
<p><img src="https://user-images.githubusercontent.com/13457157/82748398-2640bf00-9daa-11ea-98e5-0032b3537969.png" alt="ads-client-tcp-loopback"></p>
<ol start="5">
<li>Restart TwinCAT system</li>
</ol>
<p>Now you can connect to the localhost using <code>targetAmsNetId</code> address of <code>127.0.0.1.1.1</code> or <code>localhost</code>.</p>
<h1 id="important%3A-writing-struct-variables">IMPORTANT: Writing STRUCT variables</h1>
<p>When writing a struct using <code>writeSymbol</code>, the given Javascript object keys are handled as case-insensitive because the TwinCAT 3 system is case-insensitive.</p>
<p>In practise this means that the following Javascript objects are used as-equals if passing to the <code>writeSymbol</code> method:</p>
<pre class="prettyprint source lang-js"><code>{
  sometext: 'hello',
  somereal: 3.14
}
</code></pre>
<pre class="prettyprint source lang-js"><code>{
  SOmeTEXT: 'hello',
  SOMEreal: 3.14
}
</code></pre>
<p><strong>NOTE</strong> If the object has multiple keys with same name, <code>writeSymbol</code> tries to find the same case as in PLC. If it's not found, it depends on the <code>Object.find()</code> method which one is selected.</p>
<pre class="prettyprint source lang-js"><code>//In this case, probably the first one (sometext) is selected and the SOMEtext is skipped.
{
  sometext: 'hello',
  SOMEtext: 'good day'
}
</code></pre>
<h1 id="important%3A-things-to-know-when-using-with-twincat-2">IMPORTANT: Things to know when using with TwinCAT 2</h1>
<p>Almost everything should work with TwinCAT 2 but please understand the following</p>
<h2 id="twincat-2-first-plc-runtime-ads-port-is-801-instead-of-851">TwinCAT 2 first PLC runtime ADS port is 801 instead of 851</h2>
<pre class="prettyprint source lang-js"><code>const client = new ads.Client({
  targetAmsNetId: '...', 
  targetAdsPort: 801, //NOTE
})
</code></pre>
<h2 id="variable-names-are-returned-in-uppercase-on-tc2-systems">Variable names are returned in UPPERCASE on TC2 systems</h2>
<p>This might cause problems if your app is used with both TC2 &amp; TC3 systems.</p>
<p><img src="https://user-images.githubusercontent.com/13457157/86540055-96df0d80-bf0a-11ea-8f94-7e04515213c2.png" alt="image"></p>
<h2 id="global-variable-paths-are-given-different-on-tc2">Global variable paths are given different on TC2</h2>
<p>The GVL name is not given, dot (.) is used instead.</p>
<pre class="prettyprint source lang-js"><code>await client.readSymbol('GVL_Test.ExampleSTRUCT') //TwinCAT 3
await client.readSymbol('.ExampleSTRUCT') //TwinCAT 2
</code></pre>
<h2 id="invokerpcmethod-is-not-possible-on-tc2">InvokeRpcMethod is not possible on TC2</h2>
<p>This is the only one non-working feature as there are no methods in TC2.</p>
<h1 id="getting-started">Getting started</h1>
<p>This chapter includes some short getting started examples. See the JSDoc <a href="#documentation">documentation</a> for detailed description of library classes and methods.</p>
<h2 id="data-types-used-in-getting-started">Data types used in getting started</h2>
<p>These examples assume that the PLC has the following Global Variable List (GVL):</p>
<pre class="prettyprint source"><code>//GVL_Test
VAR_GLOBAL
  TestINT           : INT := 1234;
  TestSTRING        : STRING := 'Hello this is a test string';
  ExampleSTRUCT     : ST_Example;
  TestARRAY         : ARRAY[0..4] OF INT := [0, 10, 200, 3000, 4000];
  TestARRAY2        : ARRAY[0..4] OF ST_Example := [(SomeText := 'Just for demo purposes')];
  TestENUM          : E_TestEnum := E_TestEnum.Running;
  IncrementingValue : INT; //This should change every 500 ms or so
  TestTimer         : TON := (PT := T#2S500MS);
END_VAR
</code></pre>
<p>The <code>ST_Example</code> should be defined as below:</p>
<pre class="prettyprint source"><code>TYPE ST_Example :
STRUCT
	SomeText : STRING(50) := 'Hello ads-client';
	SomeReal : REAL := 3.14159265359;
	SomeDate : DT := DT#2020-4-13-12:25:33;
END_STRUCT
END_TYPE
</code></pre>
<p>The <code>E_TestEnum</code> should be defined as below:</p>
<pre class="prettyprint source"><code>TYPE E_TestEnum :
(
	Disabled 	:= 0,
	Starting 	:= 50,
	Running 	:= 100,
	Stopping	:= 200	
);
END_TYPE
</code></pre>
<h2 id="creating-a-new-client-instance">Creating a new Client instance</h2>
<p>The constructor takes settings as its parameter. Two settings are mandatory: <code>targetAmsNetId</code> and <code>targetAdsPort</code>. The first is the target PLC system AmsNetId (like <em>127.0.0.1.1.1</em> or <em>192.168.1.10.1.1</em>) and the latter is target system ADS port (<em>like 851 for TwinCAT 3 runtime 1</em>).</p>
<p>See all settings from the <a href="https://jisotalo.github.io/ads-client/global.html#Settings">Settings documentation</a></p>
<pre class="prettyprint source lang-js"><code>const ads = require('ads-client')

//Creates a new Client instance and sets the local system and TC3 runtime 1 as target
const client = new ads.Client({
  targetAmsNetId: '127.0.0.1.1.1', //Loopback address, same as 'localhost' since version 1.1.0
  targetAdsPort: 851,
})
</code></pre>
<h2 id="connecting-and-disconnecting">Connecting and disconnecting</h2>
<p>Connecting to the local TwinCAT 3 runtime 1 (port is 851) using local ADS router (= you have TwinCAT ADS router installed).</p>
<pre class="prettyprint source lang-js"><code>const ads = require('ads-client')

const client = new ads.Client({
  targetAmsNetId: '127.0.0.1.1.1',
  targetAdsPort: 851
})

client.connect()
  .then(res => {   
    console.log(`Connected to the ${res.targetAmsNetId}`)
    console.log(`Router assigned us AmsNetId ${res.localAmsNetId} and port ${res.localAdsPort}`)

    return client.disconnect()
  })
  .then(() => {
    console.log('Disconnected')
  })
  .catch(err => {
    console.log('Something failed:', err)
  })

/*
Example console output:

Connected to the 127.0.0.1.1.1
Router assigned us AmsNetId 192.168.1.1.1.1 and port 36837
Disconnected
*/
</code></pre>
<h2 id="reading-any-type-plc-variable">Reading any type PLC variable</h2>
<p>Using <code>readSymbol</code> method it is possible to read variables of <strong>any type</strong> from the PLC. These include base scalar type variables, structs, function blocks, arrays and so on. These examples cover just a few cases.</p>
<p>See full <code>readSymbol</code> documentation <a href="https://jisotalo.github.io/ads-client/Client.html#readSymbol">from the docs</a>.</p>
<h3 id="example%3A-reading-int-type-variable">Example: Reading <code>INT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>//Using Promises
client.readSymbol('GVL_Test.TestSTRING')
  .then(res => {
    console.log(`Value read: ${res.value}`)
  })
  .catch(err => {
    console.log('Something failed:', err)
  })

/*
Example console output:

Value read: 1234
*/
</code></pre>
<hr>
<h3 id="example%3A-reading-string-type-variable">Example: Reading <code>STRING</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>client.readSymbol('GVL_Test.TestSTRING')
  .then(res => {
    console.log(`Value read: ${res.value}`)
  })
  .catch(err => {
    console.log('Something failed:', err)
  })
/*
Example console output:

Value read: Hello this is a test string
*/
</code></pre>
<hr>
<h3 id="example%3A-reading-enum-type-variable">Example: Reading <code>ENUM</code> type variable</h3>
<p>If setting <code>objectifyEnumerations</code> is set to false, only ENUM value (number) is returned. As default, both string representation and integer value are returned.</p>
<pre class="prettyprint source lang-js"><code>//objectifyEnumerations: true
client.readSymbol('GVL_Test.TestENUM')
  .then(res => {
    console.log(`Value read: ${res.value}`)
  })
  .catch(err => {
    console.log('Something failed:', err)
  })

/*
Example console output:

Value read: { name: 'Running', value: 100 }
*/
</code></pre>
<hr>
<h3 id="example%3A-reading-struct-type-variable">Example: Reading <code>STRUCT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>//Using await for example purposes
try {
  const res = await client.readSymbol('GVL_Test.ExampleSTRUCT')

  console.log('Value read:', res.value)
} catch (err) {
  console.log('Reading failed:', err)
}

/*
Example console output:

Value read: { SomeText: 'Hello ads-client',
  SomeReal: 3.1415927410125732,
  SomeDate: 2020-04-13T12:25:33.000Z }   
*/
</code></pre>
<hr>
<h3 id="example%3A-reading-array-of-int-type-variable">Example: Reading <code>ARRAY OF INT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.readSymbol('GVL_Test.TestARRAY')

  console.log('Value read:', res.value)
} catch (err) {
  console.log('Reading failed:', err)
}

/*
Example console output:

Value read: [ 0, 10, 200, 3000, 4000 ] 
*/
</code></pre>
<hr>
<h3 id="example%3A-reading-array-of-struct-type-variable">Example: Reading <code>ARRAY OF STRUCT</code> type variable</h3>
<pre class="prettyprint source lang-javascript"><code>try {
  const res = await client.readSymbol('GVL_Test.TestARRAY2')

  console.log('Value read:', res.value)
} catch (err) {
  console.log('Reading failed:', err)
}

/*
Example console output:

Value read: [ { SomeText: 'Just for demo purposes',
    SomeReal: 3.1415927410125732,
    SomeDate: 2020-04-13T12:25:33.000Z },
  { SomeText: 'Hello ads-client',
    SomeReal: 3.1415927410125732,
    SomeDate: 2020-04-13T12:25:33.000Z },
  { SomeText: 'Hello ads-client',
    SomeReal: 3.1415927410125732,
    SomeDate: 2020-04-13T12:25:33.000Z },
  { SomeText: 'Hello ads-client',
    SomeReal: 3.1415927410125732,
    SomeDate: 2020-04-13T12:25:33.000Z },
  { SomeText: 'Hello ads-client',
    SomeReal: 3.1415927410125732,
    SomeDate: 2020-04-13T12:25:33.000Z } ]
*/
</code></pre>
<hr>
<h3 id="example%3A-reading-function-block-type-variable">Example: Reading <code>FUNCTION BLOCK</code> type variable</h3>
<p>Example of reading <code>TON</code> timer function block.</p>
<pre class="prettyprint source lang-javascript"><code>try {
  const res = await client.readSymbol('GVL_Test.TestTimer')

  console.log('Value read:', res.value)
} catch (err) {
  console.log('Reading failed:', err)
}

/*
Example console output:

Value read: { IN: false, PT: 2500, Q: false, ET: 0, M: false, StartTime: 0 }
*/
</code></pre>
<hr>
<h2 id="writing-any-type-plc-variable">Writing any type PLC variable</h2>
<p>Using <code>writeSymbol</code> method it is possible to write variables of <strong>any type</strong> to the PLC. These include base scalar type variables, structs, function blocks, arrays and so on. These examples cover just a few cases.</p>
<p>See full <code>writeSymbol</code> documentation <a href="https://jisotalo.github.io/ads-client/Client.html#writeSymbol">from the docs</a>.</p>
<hr>
<h3 id="example%3A-writing-int-type-variable">Example: Writing <code>INT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.TestINT', 5)

  console.log('Value written:', res.value)
} catch (err) {
  console.log('Something failed:', err)
}
</code></pre>
<hr>
<h3 id="example%3A-writing-string-type-variable">Example: Writing <code>STRING</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>
try {
  const res = await client.writeSymbol('GVL_Test.TestSTRING', 'Changing the string value to this')

  console.log('Value written:', res.value)
} catch (err) {
  console.log('Something failed:', err)
}
</code></pre>
<hr>
<h3 id="example%3A-writing-enum-type-variable">Example: Writing <code>ENUM</code> type variable</h3>
<p>When writing <code>ENUM</code> value, it can always be given as number or string.</p>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.TestENUM', 'Starting')
  //The following does the same:
  //const res = await client.writeSymbol('GVL_Test.TestENUM', 50)

  console.log('Value written:', res.value)
} catch (err) {
  console.log('Something failed:', err)
}
</code></pre>
<hr>
<h3 id="example%3A-writing-struct-type-variable">Example: Writing <code>STRUCT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.ExampleSTRUCT', {
    SomeText: 'Hello to you too, Mr. PLC!',
    SomeReal: 5456.06854,
    SomeDate: new Date()
  })

  console.log('Value written:', res.value)
} catch (err) {
  console.log('Something failed:', err)
}
</code></pre>
<h3 id="example%3A-writing-struct-type-variable-(with-autofill-parameter)">Example: Writing <code>STRUCT</code> type variable (with autoFill parameter)</h3>
<hr>
<p>The following code will not work. The PLC struct has three members but we provide only two, which causes an exception.</p>
<pre class="prettyprint source lang-js"><code>//NOTE: This won't work
try {
  const res = await client.writeSymbol('GVL_Test.ExampleSTRUCT', {
    SomeReal: 123.45,
    SomeText: 'This will not work...'
  })

} catch (err) {
  console.log('Something failed:', err)
}

/*
Example console output

Something failed: { ClientException: Writing symbol GVL_Test.ExampleSTRUCT failed: Given Javascript object is missing key/value for at least &quot;.SomeDate&quot; (DATE_AND_TIME) - Set writeSymbol() 3rd parameter (autoFill) to true to allow uncomplete objects
    at Promise ...
*/
</code></pre>
<p>We need to tell the <code>WriteSymbol</code> that we <strong>indeed</strong> want to write just some members and the rest will stay the same. This happens by setting the 3rd parameter <code>autoFill</code> to true.</p>
<p>If <code>autoFill</code> is true, the method first reads the latest value and then writes it with only the new given changes.</p>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.ExampleSTRUCT', {
    SomeReal: 123.45,
    SomeText: 'But this works!'
  }, true) //Note this!

  console.log('Value written:', res.value)

} catch (err) {
  console.log('Something failed:', err)
}
</code></pre>
<p>Of course, it would be possible to do with two separate commands too:</p>
<pre class="prettyprint source lang-js"><code>res = await client.writeSymbol('GVL_Test.ExampleSTRUCT.SomeReal', 123.45)
res = await client.writeSymbol('GVL_Test.ExampleSTRUCT.SomeText', 'This is also possible')
</code></pre>
<hr>
<h3 id="example%3A-writing-array-of-int-type-variable">Example: Writing <code>ARRAY OF INT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.TestArray', [9999, 8888, 6666, 5555, 4444])

  console.log('Value written:', res.value)

} catch (err) {
  console.log('Something failed:', err)
  return
}
</code></pre>
<hr>
<h3 id="example%3A-writing-array-of-struct-type-variable">Example: Writing <code>ARRAY of STRUCT</code> type variable</h3>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.TestArray', 
    [ { SomeText: 'First value',
        SomeReal: 1.0,
        SomeDate: new Date()},
      { SomeText: 'Second',
        SomeReal: 10.10,
        SomeDate: new Date()},
      { SomeText: 'Third',
        SomeReal: 20.20,
        SomeDate: new Date()},
      { SomeText: 'Fourth',
        SomeReal: 30.30,
        SomeDate: new Date()},
      { SomeText: 'Fifth',
        SomeReal: 40.40,
        SomeDate: new Date()}]
  )

  console.log('Value written:', res.value)
  
} catch (err) {
  console.log('Something failed:', err)
  return
}
</code></pre>
<hr>
<h3 id="example%3A-writing-function-block-type-variable">Example: Writing <code>FUNCTION BLOCK</code> type variable</h3>
<p>Starting a timer from Node.js and setting time to 60 seconds.</p>
<p><strong>NOTE:</strong> Using autoFill parameter to keep the rest as-is.</p>
<pre class="prettyprint source lang-js"><code>try {
  const res = await client.writeSymbol('GVL_Test.TestTimer', {
    IN: true, 
    PT: 60000,
  }, true)

  console.log('Value written:', res.value)
} catch (err) {
  console.log('Something failed:', err)
}

/*
Example console output

Value written: { IN: true, PT: 60000, Q: false, ET: 0, M: false, StartTime: 0 }
*/
</code></pre>
<h2 id="subscribing-to-plc-variables-(device-notifications)">Subscribing to PLC variables (device notifications)</h2>
<p>By using <code>subscribe</code> method, we can receive variable values automatically from the PLC if they change or periodically.</p>
<p>See full <code>subscribe</code> documentation <a href="https://jisotalo.github.io/ads-client/Client.html#subscribe">from the docs</a>.</p>
<hr>
<h3 id="subcribe-to-variable-value-(on-change)">Subcribe to variable value (on-change)</h3>
<p>The following wants the PLC to check if the value has changed every 1000 milliseconds. If it has changed, callback is called with the latest value in <code>data</code> parameter.</p>
<p>After 10 seconds the subscription is unsubscribed.</p>
<pre class="prettyprint source lang-js"><code>try {
  let subscription = await client.subscribe('GVL_Test.IncrementingValue', (data, sub) => {
    //Note: The sub parameter is the same as returned by client.subcribe()
    console.log(`${data.timeStamp}: Value changed to ${data.value}`)

  }, 1000)

  console.log(`Subscribed to ${subscription.target}`)

  //Unsubscribe and disconnect after 10 seconds
  setTimeout((async () => {
    //The subscribe() returns object that contains unsubscribe() method
    await subscription.unsubscribe()

    console.log('Unsubscribed')
  }), 10000)

} catch (err) {
  console.log('Something failed:', err)
  return
}

/*
Example console output

Subscribed to GVL_Test.IncrementingValue
Mon Apr 13 2020 13:02:26 GMT+0300 (GMT+03:00): Value changed to 1586
Mon Apr 13 2020 13:02:27 GMT+0300 (GMT+03:00): Value changed to 1588
Mon Apr 13 2020 13:02:28 GMT+0300 (GMT+03:00): Value changed to 1590
...
Mon Apr 13 2020 13:02:34 GMT+0300 (GMT+03:00): Value changed to 1602
Unsubscribed
</code></pre>
<hr>
<h3 id="subcribe-to-variable-value-(cyclic)">Subcribe to variable value (cyclic)</h3>
<p>The following wants the PLC to send the variable value every 1000 milliseconds. The callback is called with the latest value in <code>data</code> parameter (it might have changed or not).</p>
<pre class="prettyprint source lang-js"><code>//Our callback function
const onChange = (data, sub) => {
  console.log(`${data.timeStamp}: ${sub.target} changed to ${data.value}`)

  //We can call sub.unsubscribe() here if we want
}

try {
  let subscription = await client.subscribe('GVL_Test.IncrementingValue', onChange, 1000, false)

  console.log(`Subscribed to ${subscription.target}`)

} catch (err) {
  console.log('Something failed:', err)
  return
}

/*
Example console output


Subscribed to GVL_Test.IncrementingValue
Mon Apr 13 2020 13:09:04 GMT+0300 (GMT+03:00): GVL_Test.IncrementingValue changed to 273
Mon Apr 13 2020 13:09:05 GMT+0300 (GMT+03:00): GVL_Test.IncrementingValue changed to 275
Mon Apr 13 2020 13:09:06 GMT+0300 (GMT+03:00): GVL_Test.IncrementingValue changed to 277
...
</code></pre>
<h2 id="reading-and-writing-raw-data">Reading and writing raw data</h2>
<p>It's possible to read and write raw data using ads-client. Reading will result in a <code>Buffer</code> object, that contains the read data as bytes. Writing accepts a <code>Buffer</code> object that is then written to the PLC.</p>
<p>Handling raw data is usually the most fastest and efficient way, as there is usually much less network traffic required. The methods require known <code>indexGroup</code> and <code>indexOffset</code> values.</p>
<h3 id="getting-symbol-index-group%2C-offset-and-size">Getting symbol index group, offset and size</h3>
<p>Variable symbol information can be acquired with method <code>getSymbolInfo</code>. The symbol infoc contains required <code>indexGroup</code>, <code>indexOffset</code> and <code>size</code>.</p>
<pre class="prettyprint source lang-js"><code>const info = await client.getSymbolInfo('GVL_Test.TestINT')
console.log(info)
/*
{ indexGroup: 16448,
  indexOffset: 414816,
  size: 2,
  dataType: 2,
  dataTypeStr: 'ADST_INT16',
  flags: 8,
  flagsStr: [ 'TypeGuid' ],
  arrayDimension: 0,
  nameLength: 16,
  typeLength: 3,
  commentLength: 0,
  name: 'GVL_Test.TestINT',
  type: 'INT',
  comment: '' }
*/
</code></pre>
<h3 id="reading-a-single-raw-value">Reading a single raw value</h3>
<pre class="prettyprint source lang-js"><code>//Reading DINT from indexGroup 16448 and indexOffset 411836 (4 bytes)
const result = await client.readRaw(16448, 411836, 4)
console.log(result) //&lt;Buffer 37 61 00 00>
</code></pre>
<h3 id="writing-a-single-raw-value">Writing a single raw value</h3>
<pre class="prettyprint source lang-js"><code>//Writing value 123 to DINT from indexGroup 16448 and indexOffset 411836 (4 bytes)
const data = Buffer.alloc(4)
data.writeInt32LE(123)

await client.writeRaw(16448, 411836, data)
</code></pre>
<h3 id="reading-multiple-raw-values">Reading multiple raw values</h3>
<p>Starting from version 1.3.0 you can use ADS sum commands to read multiple values in a single request. This is faster than reading one by one.</p>
<p>Method returns an array of results, one result object for each read operation. If result has <code>success</code> of true, the read was succesful and data is located in <code>data</code>. Otherwise error information can be read from <code>errorInfo</code>.</p>
<pre class="prettyprint source lang-js"><code>const result = await client.readRawMulti([
  {
    indexGroup: 16448,
    indexOffset: 411836,
    size: 4
  },{
    indexGroup: 123, //Note: Incorrect on purpose
    indexOffset: 436040,
    size: 255
  }
])
console.log(result)
/*
[ { success: true,
    errorInfo: { error: false, errorCode: 0, errorStr: 'No error' },
    target: { indexGroup: 16448, indexOffset: 411836 },
    data: &lt;Buffer 00 43 3a d4> },
  { success: false,
    errorInfo:
     { error: true, errorCode: 1794, errorStr: 'Invalid index group' },
    target: { indexGroup: 123, indexOffset: 436040 },
    data:
     &lt;Buffer 00 00 00 00 ... > } ]
*/
</code></pre>
<h3 id="writing-multiple-raw-values">Writing multiple raw values</h3>
<p>Starting from version 1.3.0 you can use ADS sum commands to write multiple values in a single request. This is faster than writing one by one.</p>
<p>Method returns an array of results, one result object for each write operation. If result has <code>success</code> of true, the write was succesful. Otherwise error information can be read from <code>errorInfo</code>.</p>
<pre class="prettyprint source lang-js"><code>//Create raw data for DINT with value 555
const data = Buffer.alloc(4)
data.writeInt32LE(555)

const result = await client.writeRawMulti([
  {
    indexGroup: 16448,
    indexOffset: 411836,
    data: data
  },{
    indexGroup: 123, //Note: Incorrect on purpose
    indexOffset: 436040,
    data: Buffer.alloc(255)
  }
])
console.log(result)
/*
[ { success: true,
    errorInfo: { error: false, errorCode: 0, errorStr: 'No error' },
    target: { indexGroup: 16448, indexOffset: 411836 } },
  { success: false,
    errorInfo:
     { error: true,
       errorCode: 1793,
       errorStr: 'Service is not supported by server' },
    target: { indexGroup: 123, indexOffset: 436040 } } ]
*/
</code></pre>
<h3 id="creating-a-variable-handle-and-reading-a-raw-value">Creating a variable handle and reading a raw value</h3>
<p>Using handles is another alternative for reading and writing raw data. A handle is first made using variable name and then using the returned handle, read and write operations can be made. No need to know <code>indexGroup</code> and <code>indexOffset</code>.</p>
<p>NOTE: Handles should always be deleted if no more used. This doesn't mean that it wouldn't be a good habit to use the same handle all the time (for example in application backend until app is terminated). The reason is that there are limited number of handles available.</p>
<pre class="prettyprint source lang-js"><code>const handle = await client.createVariableHandle('GVL_Test.TestINT')
console.log(handle)
//{ handle: 905969897, size: 2, type: 'INT' }

const result = await client.readRawByHandle(handle)
console.log(result)
//&lt;Buffer d2 04>

await client.deleteVariableHandle(handle)
</code></pre>
<h3 id="creating-a-variable-handle-and-writing-a-raw-value">Creating a variable handle and writing a raw value</h3>
<p>See <em>Creating a variable handle and reading a raw value</em> for more info about handles.</p>
<pre class="prettyprint source lang-js"><code>const handle = await client.createVariableHandle('GVL_Test.TestINT')
console.log(handle)
//{ handle: 905969897, size: 2, type: 'INT' }

//Create raw data for INT with value 12345
const data = Buffer.alloc(2)
data.writeInt32LE(12345)

await client.writeRawByHandle(handle, data)
await client.deleteVariableHandle(handle)
</code></pre>
<h3 id="converting-a-raw-value-to-javascript-object">Converting a raw value to Javascript object</h3>
<p>Using <code>convertFromRaw</code> method, raw data can be converted to Javascript object. The conversion works internally like in <code>readSymbol</code>.</p>
<pre class="prettyprint source lang-js"><code>//result = &lt;Buffer 37 61 00 00>
const value = await client.convertFromRaw(result, 'DINT')
console.log(value) //24887
</code></pre>
<p>Example with <code>readRawMulti</code> and custom struct:</p>
<pre class="prettyprint source lang-js"><code>const result = await client.readRawMulti([
  {
    indexGroup: 16448,
    indexOffset: 449659,
    size: 59
  },{
    indexGroup: 16448,
    indexOffset: 436040,
    size: 255
  }
])

const value = await client.convertFromRaw(result[0].data, 'ST_Example')
console.log(value)
/*
{ SomeText: 'Hello ads-client',
  SomeReal: 3.1415927410125732,
  SomeDate: 2020-04-13T12:25:33.000Z }
*/
</code></pre>
<h3 id="converting-a-javascript-object-to-raw-value">Converting a Javascript object to raw value</h3>
<p>Using <code>convertToRaw</code> method, Javascript object can be converted to raw data. The conversion works internally like in <code>writeSymbol</code>.</p>
<pre class="prettyprint source lang-js"><code>const data = await client.convertToRaw(12345, 'INT')
console.log(data) //&lt;Buffer 39 30>
</code></pre>
<p>The 3rd parameter <code>autoFill</code> works as in <code>writeSymbol</code>.</p>
<pre class="prettyprint source lang-js"><code>const data = await client.convertToRaw(
  {
    SomeText: 'Hello ads-client',
    SomeReal: 3.1415927410125732,
  }, 'ST_Example', true //NOTE: autoFill=true (as there is no SomeDate given)
)
console.log(data)
//&lt;Buffer 48 65 6c 6c 6f 20 ... >
</code></pre>
<h2 id="calling-a-function-block-method-with-parameters-using-rpc-(remote-procedure-call)">Calling a function block method with parameters using RPC (remote procedure call)</h2>
<p>Starting from version 1.8.0, it is possible to call function block methods directly from Node.js. Input and output parameters are available as well as method return value. <strong>Only supported on TwinCAT 3.</strong></p>
<hr>
<p><strong>WARNING - IMPORTANT NOTE</strong></p>
<ul>
<li>Do not use online change if you change RPC method parameters or return data types</li>
<li>Make sure that parameters and return value have no <code>pack-mode</code> pragmas defined, otherwise data might be corrupted</li>
<li>Do not use <code>ARRAY</code> values directly in parameters or return value, encapsulate arrays inside struct and use the struct instead</li>
<li>The feature is new and there might some bugs as it's not well documented by Beckhoff</li>
</ul>
<hr>
<p>In the following example we have a function block named <code>FB_RpcTest</code>. There is an instance of it at global variable list with a path of <code>GVL_Test.RpcTest</code>.</p>
<p><img src="https://user-images.githubusercontent.com/13457157/86382902-9cccb880-bc96-11ea-83b8-daae9de65a66.png" alt="image"></p>
<h3 id="calling-a-simple-rpc-method">Calling a simple RPC method</h3>
<p>The code of <code>Calculator</code> method is the following. It has also VAR_OUTPUT parameters. Idea is that calculation is returned as outputs and return value tells if it was succesful.</p>
<pre class="prettyprint source"><code>{attribute 'TcRpcEnable'}
METHOD Calculator : BOOL
VAR_INPUT
  Value1	: REAL;
  Value2	: REAL;
END_VAR
VAR_OUTPUT
  Sum       : REAL;
  Product   : REAL;
  Division  : REAL;
END_VAR

//--- Code begins ---

//Return TRUE if all success
Calculator := TRUE;

Sum := Value1 + Value2;
Product := Value1 * Value2;

IF Value2 &lt;> 0 THEN
	Division := Value1 / Value2;
ELSE
	Division := 0;
	Calculator := FALSE;
END_IF
</code></pre>
<p>The method can be called from Node.js:</p>
<pre class="prettyprint source lang-js"><code>const result = await client.invokeRpcMethod(&quot;GVL_Test.RpcTest&quot;,&quot;Calculator&quot;, {
    Value1: 100.50,
    Value2: 2.2
})

console.log(result)

/*
Example console output:

{
  returnValue: true,
  outputs: {
    Sum: 102.69999694824219,
    Product: 221.10000610351562,
    Division: 45.68181610107422
  }
}
*/
</code></pre>
<h3 id="using-structs-with-rpc-methods">Using structs with RPC methods</h3>
<p>The code of the <code>StructTest</code> method is following. It has only one input and a return value (both are structs).</p>
<pre class="prettyprint source"><code>{attribute 'TcRpcEnable'}
METHOD StructTest : ST_Example
VAR_INPUT
	Input	: ST_Example;
END_VAR

//--- Code begins ---

StructTest.SomeText := CONCAT('Response: ', Input.SomeText);
StructTest.SomeReal := Input.SomeReal * 10.0;
StructTest.SomeDate := Input.SomeDate + T#24H;
</code></pre>
<p>The method can be called from Node.js:</p>
<pre class="prettyprint source lang-js"><code>const result = await client.invokeRpcMethod(&quot;GVL_Test.RpcTest&quot;,&quot;StructTest&quot;, {
  Input: {
    SomeText: 'Hello RPC method',
    SomeReal: 1200.50,
    SomeDate: new Date() //2020-07-03T14:57:22.000Z
  }
})

console.log(result)
/*
Example console output:

{
  returnValue: {
    SomeText: 'Response: Hello RPC method',
    SomeReal: 12005,
    SomeDate: 2020-07-03T15:57:22.000Z
  },
  outputs: {}
}
*/
</code></pre>
<h2 id="starting-and-stopping-the-plc">Starting and stopping the PLC</h2>
<p>The PLC runtime(s) can be started and stopped using following methods. Internally <code>WriteControl()</code> is used.</p>
<p>Note that all following methods will fail, if the PLC is already in the target state.</p>
<p><strong>Starting the PLC</strong></p>
<pre class="prettyprint source lang-js"><code>await client.startPlc() //Start the PLC from settings.targetAdsPort
await client.startPlc(852) //Start the PLC from ADS port 852
</code></pre>
<p><strong>Stopping the PLC</strong></p>
<pre class="prettyprint source lang-js"><code>await client.stopPlc() //Stop the PLC from settings.targetAdsPort
await client.stopPlc(852) //Stop the PLC from ADS port 852
</code></pre>
<p><strong>Restarting the PLC</strong></p>
<pre class="prettyprint source lang-js"><code>await client.restartPlc() //Restart the PLC from settings.targetAdsPort
await client.restartPlc(852) //Restart the PLC from ADS port 852
</code></pre>
<p><strong>Reading the PLC state</strong></p>
<p>The PLC runtime state can always be read using <code>readPlcRuntimeState()</code> and the latest known state of PLC runtime at <code>settings.targetAdsPort</code> is located in <code>metaData.plcRuntimeState</code>.</p>
<pre class="prettyprint source lang-js"><code>await client.readPlcRuntimeState() //Read PLC runtime status from settings.targetAdsPort 
//Example result: { adsState: 5, adsStateStr: 'Run', deviceState: 0 }
await client.readPlcRuntimeState(852) //Read PLC runtime status from ADS port 852
</code></pre>
<h2 id="starting-and-stopping-the-twincat-system">Starting and stopping the TwinCAT system</h2>
<p>The TwinCAT system can be started and set to config mode using following methods. This can be useful for example when updating the PLC software. Internally <code>WriteControl()</code> is used.</p>
<p>Note that all following methods will fail, if the system is already in the target state/mode.</p>
<p><strong>Setting the TwinCAT system to run mode</strong></p>
<pre class="prettyprint source lang-js"><code>await client.setSystemManagerToRun()
</code></pre>
<p><strong>Setting the TwinCAT system to config mode</strong></p>
<pre class="prettyprint source lang-js"><code>await client.setSystemManagerToConfig()
</code></pre>
<p><strong>Restart TwinCAT system</strong></p>
<pre class="prettyprint source lang-js"><code>//Same as calling setSystemManagerToRun()
await client.restartSystemManager()
</code></pre>
<p><strong>Reading the TwinCAT system state</strong></p>
<p>The TwinCAT system state can always be read using <code>readSystemManagerState()</code> and the latest known state is located in <code>metaData.systemManagerState</code>.</p>
<pre class="prettyprint source lang-js"><code>await client.readSystemManagerState() //{ adsState: 5, adsStateStr: 'Run', deviceState: 1 }
</code></pre>
<h1 id="debugging">Debugging</h1>
<p>If you have problems or you are interested, you can enabled debug output to console. The ads-client uses <code>debug</code> package for debugging.</p>
<p>Debugging can be enabled from terminal or from Javascript code.</p>
<h2 id="enabling-debug-from-code">Enabling debug from code</h2>
<p>You can change the debug level with method <code>setDebugging(level)</code>:</p>
<pre class="prettyprint source lang-js"><code>client.setDebugging(2)
</code></pre>
<p>Different debug levels explained:</p>
<ul>
<li>0: No debugging (default)</li>
<li>1: Errors have full stack traces, no debug printing</li>
<li>2: Basic debug printing (same as <code>DEBUG='ads-client'</code>)</li>
<li>3: Detailed debug printing (same as <code>DEBUG='ads-client,ads-client:details'</code>)</li>
<li>4: Detailed debug printing and raw I/O data (same as <code>DEBUG='ads-client*'</code>)</li>
</ul>
<h2 id="enabling-debugging-from-terminal">Enabling debugging from terminal</h2>
<p>See the <a href="https://www.npmjs.com/package/debug">debug package</a> for instructions.</p>
<p>Example for Visual Studio Code (PowerShell):</p>
<pre class="prettyprint source lang-bash"><code>$env:DEBUG='ads-client,ads-client:details'
</code></pre>
<p>Different debug levels explained:</p>
<ul>
<li>Basic debug printing <code>DEBUG='ads-client'</code></li>
<li>Basic and detailed debug printing <code>DEBUG='ads-client,ads-client:details'</code></li>
<li>Basic, detailed and raw I/O data: <code>DEBUG='ads-client*'</code></li>
</ul>
<h1 id="faq">FAQ</h1>
<h3 id="connection-is-working-very-badly-and-lot's-of-timeouts">Connection is working very badly and lot's of timeouts</h3>
<p>Possible fixes:</p>
<ul>
<li>Remove all routes and create them again</li>
<li>Increase timeout delay setting (<code>timeoutDelay</code>)</li>
<li>If you have very fast subscriptions, try to cache all data types before subscribing using <code>readAndCacheDataTypes()</code></li>
</ul>
<h3 id="when-using-json.stringify-or-similar-i'm-getting-a-typeerror%3A-do-not-know-how-to-serialize-a-bigint">When using JSON.stringify or similar I'm getting a <code>TypeError: Do not know how to serialize a BigInt</code></h3>
<ul>
<li>JSON.stringify doesn't understand BigInt (64 bit integer) values as default</li>
<li>Use setting <code>disableBigInt: true</code> to receive Buffer objects instead of BigInts</li>
<li>Another solution is to use something like <a href="https://github.com/GoogleChromeLabs/jsbi/issues/30#issuecomment-521460510">this</a></li>
</ul>
<h3 id="can-i-connect-from-raspberry-pi-to-twincat%3F">Can I connect from Raspberry Pi to TwinCAT?</h3>
<p>Absolutely. See chapter &quot;Supported platforms and setups&quot;, but basically:</p>
<ol>
<li>Open a TCP port 48898 from your PLC</li>
<li>Edit StaticRoutes.xml file from your PLC</li>
<li>Connect from Raspberry using the PLC IP address as router address and the local AMS Net Id you wrote to StaticRoutes.xml</li>
</ol>
<h3 id="receiving-ads-error-1808-symbol-not-found-even-when-it-should-be-found">Receiving ADS error 1808 <code>Symbol not found</code> even when it should be found</h3>
<ul>
<li>Make sure you have updated the latest PLC software using <em>download</em>. It seems that online change isn't updating everything.</li>
<li>If you are using TwinCAT 2, see chapter <a href="#important-things-to-know-when-using-with-twincat-2">IMPORTANT: Things to know when using with TwinCAT 2</a></li>
</ul>
<h1 id="documentation">Documentation</h1>
<p>You can find the full html documentation from the project <a href="https://jisotalo.github.io/ads-client/">GitHub home page</a> as well as from <code>./docs/</code> folder in the repository.</p>
<h1 id="license">License</h1>
<p>Licensed under <a href="http://www.opensource.org/licenses/MIT">MIT License</a> so commercial use is possible but without any warranty. Please respect the license, linking to this page is also much appreciated as the project has taken over 200 hours :)</p>
<p>Copyright (c) 2020 Jussi Isotalo &lt;<a href="mailto:j.isotalo91@gmail.com">j.isotalo91@gmail.com</a>&gt;</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p></article>
    </section>






    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Sun Jul 05 2020 22:17:30 GMT+0300 (GMT+03:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>